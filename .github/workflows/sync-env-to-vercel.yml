name: Sync Environment Variables to Vercel

on:
  workflow_dispatch: # Manual trigger
    inputs:
      environment:
        description: 'Environment to sync to'
        required: true
        type: choice
        options:
          - production
          - preview
          - development
      confirm:
        description: 'Type "sync" to confirm'
        required: true
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/workflows/**'

jobs:
  sync-env:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm == 'sync')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "env=production" >> $GITHUB_OUTPUT
          fi

      - name: Sync GitHub Secrets to Vercel
        run: |
          # Sync environment variables from GitHub Secrets to Vercel
          # Uses Change Data Capture (CDC) approach: only sync variables that don't exist
          
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export VERCEL_ORG_ID="${{ secrets.VERCEL_ORG_ID }}"
          export VERCEL_PROJECT_ID="${{ secrets.VERCEL_PROJECT_ID }}"
          TARGET_ENV="${{ steps.env.outputs.env }}"
          
          echo "üîÑ Syncing environment variables to $TARGET_ENV..."
          echo "üìã Project ID: $VERCEL_PROJECT_ID"
          echo "üìã Org ID: $VERCEL_ORG_ID"
          
          # Verify Vercel CLI is working
          vercel --version || echo "‚ö†Ô∏è  Vercel CLI check failed"
          
          # Step 1: Fetch existing variables from Vercel (Change Data Capture)
          echo ""
          echo "üìã Fetching existing Vercel environment variables for $TARGET_ENV..."
          EXISTING_VARS_JSON=$(vercel env ls "$TARGET_ENV" \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" \
            --json 2>/dev/null || echo "[]")
          
          # Extract variable names from JSON output
          if command -v jq >/dev/null 2>&1; then
            EXISTING_VARS=$(echo "$EXISTING_VARS_JSON" | jq -r '.[].key' | sort || echo "")
          else
            # Fallback: use grep/awk if jq is not available
            EXISTING_VARS=$(echo "$EXISTING_VARS_JSON" | grep -o '"key":"[^"]*"' | sed 's/"key":"\([^"]*\)"/\1/' | sort || echo "")
          fi
          
          if [ -z "$EXISTING_VARS" ] || [ "$EXISTING_VARS_JSON" == "[]" ]; then
            echo "‚ö†Ô∏è  Could not fetch existing variables or no variables found, will sync all"
            EXISTING_VARS=""
            EXISTING_COUNT=0
          else
            EXISTING_COUNT=$(echo "$EXISTING_VARS" | grep -c . || echo "0")
            echo "‚úÖ Found $EXISTING_COUNT existing variables in $TARGET_ENV"
            if [ "$EXISTING_COUNT" -lt 10 ]; then
              echo "   Existing: $(echo "$EXISTING_VARS" | tr '\n' ' ')"
            fi
          fi
          
          # Function to check if variable exists
          var_exists() {
            local var_name=$1
            if [ -z "$EXISTING_VARS" ]; then
              return 1  # No existing vars list, assume it doesn't exist
            fi
            echo "$EXISTING_VARS" | grep -q "^${var_name}$"
          }
          
          # Track sync statistics
          SYNCED_COUNT=0
          SKIPPED_COUNT=0
          MISSING_SECRET_COUNT=0
          
          # Function to add env var if secret exists and variable doesn't exist in Vercel
          sync_var() {
            local var_name=$1
            local secret_value=$2
            local env_type=$3
            
            if [ -z "$secret_value" ]; then
              echo "‚è≠Ô∏è  Skipping $var_name (not set in GitHub Secrets)"
              MISSING_SECRET_COUNT=$((MISSING_SECRET_COUNT + 1))
              return 2  # Return code 2 = missing secret
            fi
            
            # Check if variable already exists in Vercel
            if var_exists "$var_name"; then
              echo "‚è≠Ô∏è  Skipping $var_name (already exists in $env_type)"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              return 1  # Return code 1 = skipped (exists)
            fi
            
            # Variable doesn't exist, sync it
            echo ""
            echo "üì§ Syncing $var_name to $env_type..."
            OUTPUT=$(echo "$secret_value" | vercel env add "$var_name" "$env_type" \
              --token="$VERCEL_TOKEN" \
              --scope="$VERCEL_ORG_ID" \
              2>&1)
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ $var_name successfully synced to $env_type"
              SYNCED_COUNT=$((SYNCED_COUNT + 1))
              return 0  # Return code 0 = synced successfully
            else
              # Check if it's just "already exists" or similar informational message
              if echo "$OUTPUT" | grep -qi "already exists\|already added\|already present\|updated\|added"; then
                echo "‚ÑπÔ∏è  $var_name already exists in $env_type (race condition or manual update)"
                SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                return 1  # Return code 1 = skipped (exists)
              else
                echo "‚ö†Ô∏è  Warning: Issue syncing $var_name (exit code: $EXIT_CODE):"
                echo "$OUTPUT" | head -5
                echo "   Continuing with other variables..."
                return 0  # Don't fail the entire workflow, but count as attempted
              fi
            fi
          }
          
          # Sync sensitive secrets (production only)
          if [ "$TARGET_ENV" == "production" ]; then
            sync_var "SUPABASE_SERVICE_ROLE_KEY" "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" "$TARGET_ENV"
            sync_var "STRIPE_SECRET_KEY" "${{ secrets.STRIPE_SECRET_KEY }}" "$TARGET_ENV"
            sync_var "STRIPE_WEBHOOK_SECRET" "${{ secrets.STRIPE_WEBHOOK_SECRET }}" "$TARGET_ENV"
            sync_var "RESEND_API_KEY" "${{ secrets.RESEND_API_KEY }}" "$TARGET_ENV"
            sync_var "CRON_SECRET" "${{ secrets.CRON_SECRET }}" "$TARGET_ENV"
            sync_var "CRON_JOB_ORG_API_KEY" "${{ secrets.CRON_JOB_ORG_API_KEY }}" "$TARGET_ENV"
            sync_var "OPENAI_API_KEY" "${{ secrets.OPENAI_API_KEY }}" "$TARGET_ENV"
            sync_var "CALENDAR_ENCRYPTION_KEY" "${{ secrets.CALENDAR_ENCRYPTION_KEY }}" "$TARGET_ENV"
            sync_var "GOOGLE_CLIENT_ID" "${{ secrets.GOOGLE_CLIENT_ID }}" "$TARGET_ENV"
            sync_var "GOOGLE_CLIENT_SECRET" "${{ secrets.GOOGLE_CLIENT_SECRET }}" "$TARGET_ENV"
            sync_var "OUTLOOK_CLIENT_ID" "${{ secrets.OUTLOOK_CLIENT_ID }}" "$TARGET_ENV"
            sync_var "OUTLOOK_CLIENT_SECRET" "${{ secrets.OUTLOOK_CLIENT_SECRET }}" "$TARGET_ENV"
            sync_var "OUTLOOK_TENANT_ID" "${{ secrets.OUTLOOK_TENANT_ID }}" "$TARGET_ENV"
            sync_var "NEXT_PUBLIC_GLITCHTIP_DSN" "${{ secrets.NEXT_PUBLIC_GLITCHTIP_DSN }}" "$TARGET_ENV"
            sync_var "NEXT_PUBLIC_UMAMI_URL" "${{ secrets.NEXT_PUBLIC_UMAMI_URL }}" "$TARGET_ENV"
            sync_var "NEXT_PUBLIC_UMAMI_WEBSITE_ID" "${{ secrets.NEXT_PUBLIC_UMAMI_WEBSITE_ID }}" "$TARGET_ENV"
            
            # Stripe Price IDs (non-sensitive but should be in secrets for consistency)
            sync_var "STRIPE_PRICE_ID_STANDARD_MONTHLY" "${{ secrets.STRIPE_PRICE_ID_STANDARD_MONTHLY }}" "$TARGET_ENV"
            sync_var "STRIPE_PRICE_ID_STANDARD_YEARLY" "${{ secrets.STRIPE_PRICE_ID_STANDARD_YEARLY }}" "$TARGET_ENV"
            sync_var "STRIPE_PRICE_ID_PROFESSIONAL_MONTHLY" "${{ secrets.STRIPE_PRICE_ID_PROFESSIONAL_MONTHLY }}" "$TARGET_ENV"
            sync_var "STRIPE_PRICE_ID_PROFESSIONAL_YEARLY" "${{ secrets.STRIPE_PRICE_ID_PROFESSIONAL_YEARLY }}" "$TARGET_ENV"
          fi
          
          # Sync public variables (safe for all environments)
          sync_var "NEXT_PUBLIC_SUPABASE_URL" "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" "$TARGET_ENV"
          sync_var "NEXT_PUBLIC_SUPABASE_ANON_KEY" "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" "$TARGET_ENV"
          sync_var "NEXT_PUBLIC_APP_URL" "${{ secrets.NEXT_PUBLIC_APP_URL }}" "$TARGET_ENV"
          
          # Note: If NEXT_PUBLIC_APP_URL is not set, the app uses fallback: https://nextbestmove.app
          
          echo ""
          echo "üìä Sync Summary:"
          echo "   ‚úÖ Synced: $SYNCED_COUNT new variables"
          echo "   ‚è≠Ô∏è  Skipped: $SKIPPED_COUNT existing variables"
          if [ "$MISSING_SECRET_COUNT" -gt 0 ]; then
            echo "   ‚ö†Ô∏è  Missing secrets: $MISSING_SECRET_COUNT variables (not set in GitHub Secrets)"
          fi
          echo "   üìã Total existing in Vercel: $EXISTING_COUNT variables"
          
          echo ""
          echo "üìä Verifying synced variables..."
          vercel env ls "$TARGET_ENV" \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" 2>&1 | head -20 || echo "‚ö†Ô∏è  Could not list environment variables"
          
          echo ""
          echo "‚úÖ Environment variable sync completed for $TARGET_ENV"
          echo "üìù Note: Review Vercel Dashboard to ensure all variables are set correctly"
          echo "üîÑ Trigger a redeploy in Vercel to apply new environment variables"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

