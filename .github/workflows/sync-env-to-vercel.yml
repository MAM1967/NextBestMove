name: Sync Environment Variables to Vercel

on:
  workflow_dispatch: # Manual trigger
    inputs:
      environment:
        description: 'Environment to sync to'
        required: true
        type: choice
        options:
          - production
          - preview
          - development
      confirm:
        description: 'Type "sync" to confirm'
        required: true
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/workflows/**'

jobs:
  sync-env:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm == 'sync')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "env=production" >> $GITHUB_OUTPUT
          fi

      - name: Sync GitHub Secrets to Vercel
        run: |
          # Sync environment variables from GitHub Secrets to Vercel
          # Uses Vercel CLI with non-interactive flags
          
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export VERCEL_ORG_ID="${{ secrets.VERCEL_ORG_ID }}"
          export VERCEL_PROJECT_ID="${{ secrets.VERCEL_PROJECT_ID }}"
          TARGET_ENV="${{ steps.env.outputs.env }}"
          
          echo "üîÑ Syncing environment variables to $TARGET_ENV..."
          echo "üìã Project ID: $VERCEL_PROJECT_ID"
          echo "üìã Org ID: $VERCEL_ORG_ID"
          
          # Verify Vercel CLI is working
          vercel --version || echo "‚ö†Ô∏è  Vercel CLI check failed"
          
          # Function to add env var if secret exists
          sync_var() {
            local var_name=$1
            local secret_value=$2
            local env_type=$3
            if [ -n "$secret_value" ]; then
              echo ""
              echo "üì§ Syncing $var_name to $env_type..."
              # Vercel CLI env add accepts input via stdin when piping
              # Use --force to update existing variables
              OUTPUT=$(echo "$secret_value" | vercel env add "$var_name" "$env_type" \
                --token="$VERCEL_TOKEN" \
                --scope="$VERCEL_ORG_ID" \
                --force 2>&1)
              EXIT_CODE=$?
              
              if [ $EXIT_CODE -eq 0 ]; then
                echo "‚úÖ $var_name successfully synced to $env_type"
                return 0
              else
                # Check if it's just "already exists" or similar informational message
                if echo "$OUTPUT" | grep -qi "already exists\|already added\|already present\|updated\|added"; then
                  echo "‚ÑπÔ∏è  $var_name already exists in $env_type (skipping or updated)"
                  return 0
                else
                  echo "‚ö†Ô∏è  Warning: Issue syncing $var_name (exit code: $EXIT_CODE):"
                  echo "$OUTPUT" | head -5
                  echo "   Continuing with other variables..."
                  return 0  # Don't fail the entire workflow
                fi
              fi
            else
              echo "‚è≠Ô∏è  Skipping $var_name (not set in GitHub Secrets)"
              return 0
            fi
          }
          
          # Sync sensitive secrets (production only)
          if [ "$TARGET_ENV" == "production" ]; then
            sync_var "SUPABASE_SERVICE_ROLE_KEY" "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" "$TARGET_ENV"
            sync_var "STRIPE_SECRET_KEY" "${{ secrets.STRIPE_SECRET_KEY }}" "$TARGET_ENV"
            sync_var "STRIPE_WEBHOOK_SECRET" "${{ secrets.STRIPE_WEBHOOK_SECRET }}" "$TARGET_ENV"
            sync_var "RESEND_API_KEY" "${{ secrets.RESEND_API_KEY }}" "$TARGET_ENV"
            sync_var "CRON_SECRET" "${{ secrets.CRON_SECRET }}" "$TARGET_ENV"
            sync_var "OPENAI_API_KEY" "${{ secrets.OPENAI_API_KEY }}" "$TARGET_ENV"
            sync_var "CALENDAR_ENCRYPTION_KEY" "${{ secrets.CALENDAR_ENCRYPTION_KEY }}" "$TARGET_ENV"
            sync_var "GOOGLE_CLIENT_ID" "${{ secrets.GOOGLE_CLIENT_ID }}" "$TARGET_ENV"
            sync_var "GOOGLE_CLIENT_SECRET" "${{ secrets.GOOGLE_CLIENT_SECRET }}" "$TARGET_ENV"
            sync_var "OUTLOOK_CLIENT_ID" "${{ secrets.OUTLOOK_CLIENT_ID }}" "$TARGET_ENV"
            sync_var "OUTLOOK_CLIENT_SECRET" "${{ secrets.OUTLOOK_CLIENT_SECRET }}" "$TARGET_ENV"
            sync_var "OUTLOOK_TENANT_ID" "${{ secrets.OUTLOOK_TENANT_ID }}" "$TARGET_ENV"
            
            # Stripe Price IDs (non-sensitive but should be in secrets for consistency)
            sync_var "STRIPE_PRICE_ID_STANDARD_MONTHLY" "${{ secrets.STRIPE_PRICE_ID_STANDARD_MONTHLY }}" "$TARGET_ENV"
            sync_var "STRIPE_PRICE_ID_STANDARD_YEARLY" "${{ secrets.STRIPE_PRICE_ID_STANDARD_YEARLY }}" "$TARGET_ENV"
            sync_var "STRIPE_PRICE_ID_PROFESSIONAL_MONTHLY" "${{ secrets.STRIPE_PRICE_ID_PROFESSIONAL_MONTHLY }}" "$TARGET_ENV"
            sync_var "STRIPE_PRICE_ID_PROFESSIONAL_YEARLY" "${{ secrets.STRIPE_PRICE_ID_PROFESSIONAL_YEARLY }}" "$TARGET_ENV"
          fi
          
          # Sync public variables (safe for all environments)
          sync_var "NEXT_PUBLIC_SUPABASE_URL" "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" "$TARGET_ENV"
          sync_var "NEXT_PUBLIC_SUPABASE_ANON_KEY" "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" "$TARGET_ENV"
          sync_var "NEXT_PUBLIC_APP_URL" "${{ secrets.NEXT_PUBLIC_APP_URL }}" "$TARGET_ENV"
          
          echo ""
          echo "üìä Verifying synced variables..."
          vercel env ls "$TARGET_ENV" \
            --token="$VERCEL_TOKEN" \
            --scope="$VERCEL_ORG_ID" 2>&1 | head -20 || echo "‚ö†Ô∏è  Could not list environment variables"
          
          echo ""
          echo "‚úÖ Environment variable sync completed for $TARGET_ENV"
          echo "üìù Note: Review Vercel Dashboard to ensure all variables are set correctly"
          echo "üîÑ Trigger a redeploy in Vercel to apply new environment variables"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

